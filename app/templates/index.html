<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Llama</title>
   <link rel="icon" type="image/png" href="/public/data.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Inter', sans-serif;
      background: #efedec;
      min-height: 100vh;
      display: flex;
      color: #000000;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 60px;
      height: 100vh;
      background: rgba(239, 237, 236, 0.95);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .sidebar:hover {
      width: 280px;
      background: rgba(239, 237, 236, 0.98);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.15);
    }

    .sidebar-header {
      padding: 20px 15px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      min-height: 70px;
    }

    .sidebar-icon {
      width: 30px;
      height: 30px;
      background: #000;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      font-weight: 600;
      flex-shrink: 0;
    }
 
    .sidebar-title {
      font-size: 1rem;
      font-weight: 600;
      color: #000;
      opacity: 0;
      white-space: nowrap;
      transition: opacity 0.3s ease;
    }

    .sidebar:hover .sidebar-title {
      opacity: 1;
    }

    .new-chat-btn {
      margin: 15px;
      padding: 12px;
      background: #000;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transform: translateX(-10px);
    }

    .sidebar:hover .new-chat-btn {
      opacity: 1;
      transform: translateX(0);
    }

    .new-chat-btn:hover {
      background: #333;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    .chat-history::-webkit-scrollbar {
      width: 4px;
    }

    .chat-history::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-history::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 2px;
    }

    .history-item {
      padding: 12px 15px;
      margin: 2px 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .history-item:hover {
      background: rgba(255, 255, 255, 0.7);
      border-color: rgba(0, 0, 0, 0.1);
    }

    .history-item.active {
      background: rgba(0, 0, 0, 0.1);
      border-color: rgba(0, 0, 0, 0.2);
    }

    .history-icon {
      width: 20px;
      height: 20px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .history-text {
      flex: 1;
      font-size: 0.85rem;
      color: #333;
      opacity: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: opacity 0.3s ease;
    }

    .sidebar:hover .history-text {
      opacity: 1;
    }

    .history-date {
      font-size: 0.75rem;
      color: #666;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar:hover .history-date {
      opacity: 1;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }

    #homepage .main-title {
      font-family: "PP Editorial New Ultralight", "PP Editorial New Ultralight Placeholder", serif;
      font-size: clamp(2.5rem, 6vw, 4rem);
      line-height: 1.1;
      font-weight: 300;
      color: #111;
    }

    #homepage .editorial {
      font-style: normal;
      font-weight: 300;
    }

    #homepage .editorial-italic {
      font-style: italic;
      font-weight: 300;
    }

    .container { max-width: 800px; width: 100%; text-align: center; }

    .main-title {
      font-size: clamp(2.5rem, 6vw, 4rem);
      line-height: 1.1;
      font-weight: 300;
      color: #111;
    }

    .search-section { position: relative; margin-bottom: 3rem; }
    
    /* Enhanced Search Container with Model Selector */
    .search-container {
      position: relative;
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: visible;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .search-container:focus-within {
      border-color: #000;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
    }

    .search-input-wrapper {
      display: flex;
      align-items: center;  
      gap: 12px;
      padding: 20px 70px 20px 25px;
      min-height: 60px;
    }

    .model-selector {
      position: relative;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .model-button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(239, 237, 236, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #333;
      transition: all 0.3s ease;
      white-space: nowrap;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .model-button:hover {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.25);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .model-button.active {
      background: #000;
      color: white;
      border-color: #000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .model-logo {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      object-fit: contain;
      background: linear-gradient(135deg, #656c86ff 0%, #130f16ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: white;
      overflow: hidden;
    }

    .model-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 4px;
    }

    .model-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      z-index: 1000;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 8px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .model-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .model-option {
      padding: 16px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .model-option:last-child {
      border-bottom: none;
    }

    .model-option:hover {
      background: rgba(239, 237, 236, 0.5);
      transform: translateX(2px);
    }

    .model-option.selected {
      background: #000;
      color: white;
    }

    .model-option.selected:hover {
      background: #333;
    }

    .model-option-logo {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: linear-gradient(135deg, #656c86ff 0%, #130f16ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
      overflow: hidden;
      flex-shrink: 0;
    }

    .model-option-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 6px;
    }

    .model-option-content {
      flex: 1;
      min-width: 0;
    }

    .model-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 2px;
      line-height: 1.2;
    }

    .model-description {
      font-size: 0.75rem;
      color: #666;
      line-height: 1.3;
    }

    .model-option.selected .model-description {
      color: rgba(255, 255, 255, 0.8);
    }

    .model-provider {
      font-size: 0.7rem;
      color: #999;
      font-weight: 500;
      margin-top: 2px;
    }

    .model-option.selected .model-provider {
      color: rgba(255, 255, 255, 0.6);
    }

    .search-input {
      flex: 1;
      border: none;
      font-size: 1.1rem;
      background: transparent;
      outline: none;
      color: #000;
      line-height: 1.5;
      resize: none;
      font-family: inherit;
      min-height: 24px;
    }

    .search-button {
      position: absolute; 
      right: 8px; 
      top: 50%; 
      transform: translateY(-50%);
      width: 50px; 
      height: 50px; 
      border: none; 
      border-radius: 50%;
      background: #000; 
      color: #fff; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .search-button:hover { 
      background: #333; 
      transform: translateY(-50%) scale(1.05);
    }
    
    .search-button:active { 
      background: #000; 
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
      transform: translateY(-50%) scale(0.95);
    }

    .search-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: translateY(-50%);
    }

    #searchIcon {
      font-size: 1.2rem;
      font-weight: bold;
      line-height: 1;
      transition: all 0.2s ease;
    }

    .chat-area {
      display: none; 
      max-width: 800px; 
      width: 100%;
      background: white; 
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      margin-top: 2rem; 
      overflow: hidden; 
      min-height: 400px;
    }

    .chat-header {
      background: #000; 
      color: white;
      padding: 20px; 
      text-align: center;
      font-weight: 600; 
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .chat-header-logo {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      overflow: hidden;
    }

    .chat-header-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 4px;
    }

    .chat-messages {
      max-height: 500px;
      overflow-y: auto;
      padding: 20px;
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }

    .message { 
      margin-bottom: 20px; 
      padding: 16px 20px; 
      border-radius: 16px; 
      max-width: 100%; 
    }
    
    .user-message { 
      background: #000; 
      color: white; 
      margin-left: auto; 
      text-align: right; 
    }
    
    .assistant-message { 
      background: #fafafa; 
      color: #2d3748; 
      border: 1px solid #e2e8f0; 
      line-height: 1.7; 
      text-align: left; 
    }

    /* Enhanced Table Styling */
    .assistant-message table {
      width: 100%; 
      border-collapse: collapse;
      margin: 20px 0; 
      font-size: 0.9rem;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .assistant-message th {
      background: black;
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      border: none;
      font-size: 0.95rem;
    }
    
    .assistant-message td {
      background: #fff;
      padding: 12px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
      line-height: 1.5;
    }
    
    .assistant-message tr:last-child td {
      border-bottom: none;
    }
    
    .assistant-message tr:nth-child(even) td {
      background: #f8fafc;
    }
    
    .assistant-message tr:hover td {
      background: #e6fffa;
      transition: background-color 0.2s ease;
    }

    /* Enhanced Sources Section */
    .sources-section {
      margin-top: 25px; 
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
      text-align: left; 
      word-break: break-word;
    }
    
    .sources-title {
      font-size: 1.1rem; 
      font-weight: 700;
      color: #4a5568; 
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .source-item {
      background: linear-gradient(135deg, #f8fafc, #ffffff);
      border: 1px solid #e2e8f0;
      border-radius: 12px; 
      padding: 15px;
      margin-bottom: 12px; 
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
    }
    
    .source-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .source-link {
      color: #667eea;
      text-decoration: none; 
      word-break: break-all; 
      font-weight: 500;
      transition: color 0.2s ease;
    }
    
    .source-link:hover { 
      color: #5a67d8;
      text-decoration: underline; 
    }
    
    .source-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 5px;
    }

    /* Superscript Citation Links */
    .assistant-message sup {
      font-size: 0.75em;
      line-height: 0;
      position: relative;
      vertical-align: baseline;
      top: -0.5em;
    }
    
    .assistant-message sup a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      padding: 2px 4px;
      border-radius: 4px;
      background: rgba(102, 126, 234, 0.1);
      transition: all 0.2s ease;
    }
    
    .assistant-message sup a:hover {
      background: rgba(102, 126, 234, 0.2);
      color: #5a67d8;
      text-decoration: none;
    }

    /* Enhanced Code Styling */
    pre {
      background: #1a202c;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 12px;
      overflow-x: auto;
      margin: 20px 0;
      font-size: 0.9rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      border-left: 4px solid #667eea;
    }
    
    code { 
      font-family: "Fira Code", "Monaco", "Cascadia Code", monospace;
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      color: #e53e3e;
      font-size: 0.9em;
    }
    
    pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    /* Loading Animation */
    .loading {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    
    .loading::after {
      content: "";
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Scrollbar Styling */
    .chat-messages::-webkit-scrollbar {
      width: 8px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .sidebar {
        width: 0;
        transform: translateX(-100%);
      }

      .sidebar.mobile-open {
        width: 280px;
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1001;
        background: #000;
        color: white;
        border: none;
        border-radius: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .container {
        padding-top: 80px;
      }

      .search-input-wrapper {
        flex-direction: column;
        gap: 12px;
        padding: 20px 25px 60px 25px;
        align-items: stretch;
      }

      .model-selector {
        order: -1;
        margin-top: 0;
      }

      .model-button {
        width: 100%;
        justify-content: center;
      }

      .search-button {
        bottom: 8px;
        top: auto;
        transform: none;
      }

      .search-button:hover {
        transform: scale(1.05);
      }

      .search-button:active {
        transform: scale(0.95);
      }
    }

    @media (min-width: 769px) {
      .mobile-menu-btn {
        display: none;
      }
    }

    /* Overlay for mobile */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Model dropdown scrollbar */
    .model-dropdown::-webkit-scrollbar {
      width: 6px;
    }

    .model-dropdown::-webkit-scrollbar-track {
      background: #f8f9fa;
    }

    .model-dropdown::-webkit-scrollbar-thumb {
      background: #dee2e6;
      border-radius: 3px;
    }

    .model-dropdown::-webkit-scrollbar-thumb:hover {
      background: #adb5bd;
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>

  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
     <div class="sidebar-icon">
  <img src="/public/data.png" alt="Data Llama Logo" style="width:100%; height:100%; object-fit:contain; border-radius:8px;">
</div>

      <div class="sidebar-title">Data Llama</div>
    </div>
    
    <button class="new-chat-btn" id="newChatBtn">
      <span>+</span>
      <span>New Chat</span>
    </button>
    
    <div class="chat-history" id="chatHistory">
      <!-- Chat history items will be dynamically added here -->
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container">
      <div id="homepage">
        <h1 class="main-title">
          <span class="editorial">What</span> 
          <span class="editorial-italic">can</span> 
          <span class="editorial">I help with?</span>
        </h1>
        <div class="search-section">
          <form id="searchForm">
            <div class="search-container">
              <div class="search-input-wrapper">
                <div class="model-selector">
                  <button type="button" class="model-button" id="modelButton">
                    <div class="model-logo" id="selectedModelLogo">
                        <img src="/public/gemini.jpg" alt="Gemini Logo" 
                            style="width:100%; height:100%; object-fit:contain; border-radius:4px;">
                                    </div>
                  <span id="selectedModelName">Gemini</span>
<span style="font-size: 0.7rem;">▼</span>
                  </button>
                  <div class="model-dropdown" id="modelDropdown">
                    <!-- Model options will be populated here -->
                  </div>
                </div>
                <textarea id="searchInput" class="search-input" placeholder="Ask anything..." rows="1" required></textarea>
              </div>
              <button type="submit" class="search-button" id="searchButton">
                <span id="searchIcon">→</span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="chat-area" id="chatArea">
        <div class="chat-header" id="chatHeader">
          <div class="chat-header-logo" id="chatModelLogo">G</div>
          <span id="chatModelName">Gemini 2.0 Flash</span>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
      </div>
    </div>
  </div>

  <script>
    // Model configurations with your specified models
    const MODELS = [
      {
        id: "x-ai/grok-4-fast:free",
        name: "Grok 4",
        description: "Lightning-fast responses with xAI's latest model",
        icon: "G",
        provider: "xAI",
        logo: "/public/grok.png"
      },
      {
        id: "deepseek/deepseek-chat-v3.1:free",
        name: "DeepSeek ",
        description: "Advanced reasoning and coding capabilities",
        icon: "D",
        provider: "DeepSeek",
        logo: "/public/deepseek.jpg"
      },
      {
        id: "deepseek/deepseek-chat-v3-0324:free",
        name: "DeepSeek Chat v3.0",
        description: "Efficient general-purpose AI model",
        icon: "D",
        provider: "DeepSeek",
        logo: "/public/deep2.jpg"
      },
      {
        id: "microsoft/mai-ds-r1:free",
        name: "MAI-DS R1",
        description: "Microsoft's advanced AI for data science",
        icon: "M",
        provider: "Microsoft",
        logo: "/public/microsoft.png"
      },
      {
        id: "meta-llama/llama-3.3-70b-instruct:free",
        name: "Llama 3.3 70B",
        description: "Meta's powerful model",
        icon: "L",
        provider: "Meta",
        logo: "/public/meta.jpg"
      },
      {
        id: "google/gemini-2.0-flash-exp:free",
        name: "Gemini",
        description: "Google's latest model",
        icon: "G",
        provider: "Google",
        logo: "/public/gemini.jpg"
      },
      {
        id: "openai/gpt-oss-20b:free",
        name: "GPT",
        description: "Powerful model from OpenAI",
        icon: "O",
        provider: "OpenAI",
        logo: "/public/chatgpt.png"
      },
      {
        id: "mistralai/mistral-small-3.2-24b-instruct:free",
        name: "Mistral 2",
        description: "Efficient and capable European AI",
        icon: "M",
        provider: "Mistral AI",
        logo: "/public/Mistra.png"
      },
      {
        id: "google/gemma-3-27b-it:free",
        name: "Gemma 3 27B",
        description: "Google's instruction-tuned model",
        icon: "G",
        provider: "Google",
        logo: "/public/gemini.png"
      },
      {
        id: "mistralai/mistral-7b-instruct:free",
        name: "Mistral 7B Instruct",
        description: "Compact but powerful AI model",
        icon: "M",
        provider: "Mistral AI",
        logo: "/public/Mistra.png"
      }
    ];

    // Global variables
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const chatArea = document.getElementById('chatArea');
    const chatMessages = document.getElementById('chatMessages');
    const chatHistory = document.getElementById('chatHistory');
    const newChatBtn = document.getElementById('newChatBtn');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const modelButton = document.getElementById('modelButton');
    const modelDropdown = document.getElementById('modelDropdown');
    const selectedModelName = document.getElementById('selectedModelName');
    const selectedModelLogo = document.getElementById('selectedModelLogo');
    const chatModelName = document.getElementById('chatModelName');
    const chatModelLogo = document.getElementById('chatModelLogo');
    const chatHeader = document.getElementById('chatHeader');

    let isLoading = false;
    let currentChatId = null;
    let chatHistoryData = [];
    let selectedModel = MODELS[0]; // Default to first model (Grok 4 Fast)

    // Initialize the application
    initializeApp();

    function initializeApp() {
      loadChatHistory();
      populateModelDropdown();
      setupEventListeners();
      
      // Add sample chat history after a delay
      setTimeout(() => {
        addSampleChatHistory();
      }, 1000);
    }

    function createModelLogo(model, size = 'small') {
      const logoElement = document.createElement('div');
      logoElement.className = size === 'small' ? 'model-logo' : 'model-option-logo';
      
      // Try to load the actual logo, fallback to icon
      const img = document.createElement('img');
      img.src = model.logo;
      img.alt = model.provider;
      img.onerror = function() {
        // Fallback to icon if logo fails to load
        logoElement.innerHTML = model.icon;
      };
      
      logoElement.appendChild(img);
      return logoElement;
    }

    function populateModelDropdown() {
      modelDropdown.innerHTML = '';
      
      MODELS.forEach(model => {
        const option = document.createElement('div');
        option.className = `model-option ${model.id === selectedModel.id ? 'selected' : ''}`;
        option.dataset.modelId = model.id;
        
        const logoElement = createModelLogo(model, 'large');
        
        option.innerHTML = `
          <div class="model-option-content">
            <div class="model-name">${model.name}</div>
            <div class="model-description">${model.description}</div>
            <div class="model-provider">${model.provider}</div>
          </div>
        `;
        
        option.insertBefore(logoElement, option.firstChild);
        option.addEventListener('click', () => selectModel(model));
        modelDropdown.appendChild(option);
      });
    }

    function selectModel(model) {
      selectedModel = model;
      selectedModelName.textContent = model.name;
      chatModelName.textContent = model.name;
      
      // Update model logos
      updateModelLogo(selectedModelLogo, model);
      updateModelLogo(chatModelLogo, model);
      
      // Update dropdown selection
      document.querySelectorAll('.model-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.modelId === model.id) {
          option.classList.add('selected');
        }
      });
      
      closeModelDropdown();
    }

    function updateModelLogo(logoElement, model) {
      logoElement.innerHTML = '';
      const img = document.createElement('img');
      img.src = model.logo;
      img.alt = model.provider;
      img.onerror = function() {
        logoElement.innerHTML = model.icon;
      };
      logoElement.appendChild(img);
    }

    function setupEventListeners() {
      // Mobile menu functionality
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', toggleSidebar);
      }
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
      }

      // New chat functionality
      newChatBtn.addEventListener('click', startNewChat);

      // Model selector
      modelButton.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleModelDropdown();
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!modelButton.contains(e.target) && !modelDropdown.contains(e.target)) {
          closeModelDropdown();
        }
      });

      // Search input auto-resize
      searchInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // Form submission
      searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const question = searchInput.value.trim();
        if (!question || isLoading) return;
        
        document.getElementById('homepage').style.display = 'none';
        await askQuestion(question);
      });
    }

    function toggleModelDropdown() {
      const isActive = modelDropdown.classList.contains('active');
      if (isActive) {
        closeModelDropdown();
      } else {
        openModelDropdown();
      }
    }

    function openModelDropdown() {
      modelDropdown.classList.add('active');
      modelButton.classList.add('active');
    }

    function closeModelDropdown() {
      modelDropdown.classList.remove('active');
      modelButton.classList.remove('active');
    }

    function toggleSidebar() {
      sidebar.classList.toggle('mobile-open');
      sidebarOverlay.classList.toggle('active');
    }

    function closeSidebar() {
      sidebar.classList.remove('mobile-open');
      sidebarOverlay.classList.remove('active');
    }

    function startNewChat() {
      currentChatId = Date.now().toString();
      chatArea.style.display = 'none';
      chatMessages.innerHTML = '';
      document.getElementById('homepage').style.display = 'block';
      
      // Clear active state from history items
      document.querySelectorAll('.history-item').forEach(item => {
        item.classList.remove('active');
      });
      
      closeSidebar(); // Close sidebar on mobile after starting new chat
    }

    async function askQuestion(question) {
      if (!currentChatId) {
        currentChatId = Date.now().toString();
      }

      chatArea.style.display = 'block';
      addUserMessage(question);
      showLoading();

      try {
        const formData = new FormData();
        formData.append('question', question);
        formData.append('model', selectedModel.id); // Include selected model

        // Check if there's an actual API endpoint
        let response, data;
        try {
          response = await fetch('/ask', { method: 'POST', body: formData });
          data = await response.json();
        } catch (apiError) {
          // Fallback to simulation if API is not available
          await new Promise(resolve => setTimeout(resolve, 2000));
          data = {
            ok: true,
            answer: `This is a simulated response from **${selectedModel.name}** to: "${question}". In a real implementation, this would connect to your backend API that processes the question using the selected model (${selectedModel.id}) and returns an intelligent response with proper business analysis, research citations, and comprehensive insights.

**Selected Model Details:**
- **Model**: ${selectedModel.name} (${selectedModel.provider})
- **Description**: ${selectedModel.description}
- **API ID**: ${selectedModel.id}

The backend would use this model selection to make the appropriate API call to OpenRouter with the chosen model.`,
            citations: [
              { title: "Sample Business Report", url: "https://example.com/business-report" },
              { title: "Market Analysis Data", url: "https://example.com/market-data" }
            ]
          };
        }

        hideLoading();
        if (data.ok) {
          addAssistantMessage(data.answer, data.citations);
          saveChatToHistory(question, data.answer);
        } else {
          addErrorMessage(data.error || 'Error occurred.');
        }
      } catch (error) {
        hideLoading();
        addErrorMessage('Failed to connect to the server.');
      }
    }

    function addUserMessage(message) {
      const div = document.createElement('div');
      div.className = 'message user-message';
      div.textContent = message;
      chatMessages.appendChild(div);
      scrollToBottom();
    }

    function addAssistantMessage(answer, citations) {
      const div = document.createElement('div');
      div.className = 'message assistant-message';

      let sourcesHtml = '';
      if (citations && citations.length > 0) {
        const items = citations.map((c, index) => {
          let title = '', url = '';
          
          if (typeof c === 'string') {
            const match = c.match(/^\[(\d+)\]\s*(.+?)\s*—\s*(.+)$/);
            if (match) {
              const [, number, titlePart, urlPart] = match;
              title = titlePart;
              url = urlPart;
            } else {
              const urlMatch = c.match(/(https?:\/\/[^\s]+)/);
              if (urlMatch) {
                url = urlMatch[1];
                title = c.replace(url, '').replace(/^\[\d+\]\s*/, '').replace(/\s*—\s*$/, '').trim();
              } else {
                title = c;
                url = '#';
              }
            }
          } else if (typeof c === 'object') {
            title = c.title || c.assertion || 'Source';
            url = c.url || c.source || '#';
          }

          return `
            <div class="source-item">
              <div class="source-title">[${index + 1}] ${escapeHtml(title)}</div>
              <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="source-link">
                ${escapeHtml(url)}
              </a>
            </div>
          `;
        }).join('');
        
        sourcesHtml = `
          <div class="sources-section">
            <div class="sources-title">📚 Sources</div>
            ${items}
          </div>
        `;
      }

      div.innerHTML = `<div>${formatAnswer(answer)}</div>${sourcesHtml}`;
      chatMessages.appendChild(div);
      scrollToBottom();

      if (window.MathJax) MathJax.typesetPromise();
      if (window.Prism) Prism.highlightAll();
    }

    function addErrorMessage(error) {
      const div = document.createElement('div');
      div.className = 'message assistant-message';
      div.innerHTML = `<div style="color:#e53e3e;font-weight:600;"><strong>⚠️ Error:</strong> ${escapeHtml(error)}</div>`;
      chatMessages.appendChild(div);
      scrollToBottom();
    } 

    function showLoading() {
      isLoading = true;
      const div = document.createElement('div');
      div.className = 'message assistant-message';
      div.id = 'loadingMessage';
      div.innerHTML = `<div class="loading">🔍 Agent is analyzing your question...</div>`;
      chatMessages.appendChild(div);
      scrollToBottom();
    }

    function hideLoading() {
      isLoading = false;
      const loadingDiv = document.getElementById('loadingMessage');
      if (loadingDiv) loadingDiv.remove();
    }

    function formatAnswer(answer) {
      answer = answer.replace(/\([^\)]*\[.*?\]\(.*?\)\)/g, "");
      answer = answer.replace(/^Source[s]?:.*$/gim, "");
      answer = answer.replace(/Sources?:[\s\S]*$/i, "");

      answer = answer.replace(/\$\$(.+?)\$\$/gs, "\\[$1\\]");
      answer = answer.replace(/\$(.+?)\$/g, "\\($1\\)");

      let formatted = answer
        .replace(/^### (.+)$/gm, "<h3>$1</h3>")
        .replace(/^## (.+)$/gm, "<h2>$1</h2>")
        .replace(/^# (.+)$/gm, "<h1>$1</h1>")
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/\*(.*?)\*/g, "<em>$1</em>")
        .replace(/^---$/gm, "<hr>")
        .replace(/^\s*[-*]\s*(.+)$/gm, "<li>$1</li>")
        .replace(/^\d+\.\s*(.+)$/gm, "<li>$1</li>")
        .replace(/```(\w+)?\n([\s\S]*?)```/g, (m, lang, code) => {
          return `<pre><code class="language-${lang || 'plaintext'}">${escapeHtml(code)}</code></pre>`;
        });

      formatted = formatted.replace(
        /\|(.+)\|\r?\n\|([-\s|:]+)\|\r?\n((?:\|.+\|\r?\n?)*)/g,
        (match, header, divider, body) => {
          const headers = header.split("|").map(h => `<th>${h.trim()}</th>`).join("");
          const rows = body.trim().split(/\r?\n/).filter(row => row.trim()).map(row => {
            const cells = row.split("|").filter((cell, index, arr) => index > 0 && index < arr.length - 1);
            return "<tr>" + cells.map(c => `<td>${c.trim()}</td>`).join("") + "</tr>";
          }).join("");
          return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
        }
      );

      return formatted.split(/\r?\n\r?\n/).map(p => {
        p = p.trim();
        if (!p) return '';
        if (p.startsWith("<") || p.includes("<table>") || p.includes("<h") || p.includes("<hr") || p.includes("<pre>")) return p;
        return `<p>${p}</p>`;
      }).filter(p => p).join("");
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Chat history functions
    function saveChatToHistory(question, answer) {
      const existingChatIndex = chatHistoryData.findIndex(chat => chat.id === currentChatId);
      
      if (existingChatIndex !== -1) {
        // Update existing chat
        chatHistoryData[existingChatIndex].messages.push({ question, answer, model: selectedModel.name });
        chatHistoryData[existingChatIndex].lastUpdated = new Date();
      } else {
        // Create new chat
        const newChat = {
          id: currentChatId,
          title: question.length > 50 ? question.substring(0, 50) + '...' : question,
          messages: [{ question, answer, model: selectedModel.name }],
          createdAt: new Date(),
          lastUpdated: new Date(),
          modelUsed: selectedModel.name
        };
        chatHistoryData.unshift(newChat);
      }

      // Limit history to 50 chats
      if (chatHistoryData.length > 50) {
        chatHistoryData = chatHistoryData.slice(0, 50);
      }

      renderChatHistory();
    }

    function loadChatHistory() {
      // In a real implementation, you would load from localStorage or an API
      chatHistoryData = [];
      renderChatHistory();
    }

    function renderChatHistory() {
      chatHistory.innerHTML = '';

      if (chatHistoryData.length === 0) {
        chatHistory.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #666; font-size: 0.85rem; opacity: 0;" class="empty-history">
            <div style="margin-bottom: 10px;">💬</div>
            <div>No chat history yet</div>
            <div style="font-size: 0.75rem; margin-top: 5px;">Start a conversation to see your history here</div>
          </div>
        `;
        
        // Animate the empty state when sidebar is hovered
        const emptyHistory = chatHistory.querySelector('.empty-history');
        if (emptyHistory) {
          sidebar.addEventListener('mouseenter', () => {
            emptyHistory.style.opacity = '1';
            emptyHistory.style.transition = 'opacity 0.3s ease 0.1s';
          });
          sidebar.addEventListener('mouseleave', () => {
            emptyHistory.style.opacity = '0';
            emptyHistory.style.transition = 'opacity 0.3s ease';
          });
        }
        return;
      }

      // Group chats by date
      const groupedChats = groupChatsByDate(chatHistoryData);
      
      Object.keys(groupedChats).forEach(dateGroup => {
        // Add date header
        const dateHeader = document.createElement('div');
        dateHeader.style.cssText = `
          padding: 10px 15px 5px 15px;
          font-size: 0.75rem;
          font-weight: 600;
          color: #666;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          opacity: 0;
          transition: opacity 0.3s ease;
        `;
        dateHeader.textContent = dateGroup;
        chatHistory.appendChild(dateHeader);

        // Add chats for this date
        groupedChats[dateGroup].forEach(chat => {
          const historyItem = document.createElement('div');
          historyItem.className = 'history-item';
          historyItem.dataset.chatId = chat.id;
          
          if (chat.id === currentChatId) {
            historyItem.classList.add('active');
          }

          historyItem.innerHTML = `
            <div class="history-icon">💬</div>
            <div class="history-text">${chat.title}</div>
            <div class="history-date">${formatTime(chat.lastUpdated)}</div>
          `;

          historyItem.addEventListener('click', () => loadChat(chat.id));
          chatHistory.appendChild(historyItem);
        });
      });

      // Show date headers on hover
      sidebar.addEventListener('mouseenter', () => {
        chatHistory.querySelectorAll('[style*="opacity: 0"]').forEach(header => {
          header.style.opacity = '1';
        });
      });

      sidebar.addEventListener('mouseleave', () => {
        chatHistory.querySelectorAll('[style*="text-transform: uppercase"]').forEach(header => {
          header.style.opacity = '0';
        });
      });
    }

    function groupChatsByDate(chats) {
      const groups = {};
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const lastWeek = new Date(today);
      lastWeek.setDate(lastWeek.getDate() - 7);

      chats.forEach(chat => {
        const chatDate = new Date(chat.lastUpdated);
        let groupKey;

        if (isSameDay(chatDate, today)) {
          groupKey = 'Today';
        } else if (isSameDay(chatDate, yesterday)) {
          groupKey = 'Yesterday';
        } else if (chatDate > lastWeek) {
          groupKey = 'Last 7 days';
        } else {
          groupKey = formatDateGroup(chatDate);
        }

        if (!groups[groupKey]) {
          groups[groupKey] = [];
        }
        groups[groupKey].push(chat);
      });

      return groups;
    }

    function isSameDay(date1, date2) {
      return date1.getDate() === date2.getDate() &&
             date1.getMonth() === date2.getMonth() &&
             date1.getFullYear() === date2.getFullYear();
    }

    function formatDateGroup(date) {
      const options = { month: 'long', year: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    function formatTime(date) {
      const now = new Date();
      const chatDate = new Date(date);
      const diffMs = now - chatDate;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffHours < 1) {
        return 'Now';
      } else if (diffHours < 24) {
        return `${diffHours}h`;
      } else if (diffDays === 1) {
        return '1d';
      } else if (diffDays < 7) {
        return `${diffDays}d`;
      } else {
        return chatDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    }

    function loadChat(chatId) {
      const chat = chatHistoryData.find(c => c.id === chatId);
      if (!chat) return;

      currentChatId = chatId;
      chatMessages.innerHTML = '';
      document.getElementById('homepage').style.display = 'none';
      chatArea.style.display = 'block';

      // Load all messages from this chat
      chat.messages.forEach(msg => {
        addUserMessage(msg.question);
        addAssistantMessage(msg.answer, []);
      });

      // Update active state in sidebar
      document.querySelectorAll('.history-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add('active');

      closeSidebar(); // Close sidebar on mobile after loading chat
    }

    function addSampleChatHistory() {
      // Simulate some existing chats with different models
      const sampleChats = [
        {
          id: "sample1",
          title: "Market analysis for Q4 2024",
          messages: [
            {
              question: "Can you provide a market analysis for Q4 2024?",
              answer: "Based on current market trends, Q4 2024 shows strong growth potential in tech sectors with emerging opportunities in AI-driven solutions and sustainable technologies. Key indicators suggest consumer confidence is stabilizing while enterprise spending remains robust.",
              model: "Grok 4 Fast"
            }
          ],
          createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), // 2 days ago
          lastUpdated: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
          modelUsed: "Grok 4 Fast"
        },
        {
          id: "sample2",
          title: "Competitor analysis for SaaS companies",
          messages: [
            {
              question: "What's the competitive landscape for SaaS companies?",
              answer: "The SaaS market is highly competitive with key players including Salesforce, Microsoft, and emerging unicorns. Market differentiation increasingly depends on AI integration, user experience, and vertical specialization. Price pressure continues as competition intensifies.",
              model: "DeepSeek Chat v3.1"
            }
          ],
          createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5 days ago
          lastUpdated: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
          modelUsed: "DeepSeek Chat v3.1"
        },
        {
          id: "sample3",
          title: "ROI calculation for marketing campaigns",
          messages: [
            {
              question: "How do I calculate ROI for marketing campaigns?",
              answer: "ROI for marketing campaigns can be calculated using the formula: (Revenue Generated - Marketing Cost) / Marketing Cost × 100. Consider attribution models, customer lifetime value, and multi-touch attribution for more accurate measurements. Track both short-term conversion and long-term brand impact.",
              model: "Gemini 2.0 Flash"
            }
          ],
          createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000), // 10 days ago
          lastUpdated: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000),
          modelUsed: "Gemini 2.0 Flash"
        }
      ];
      
      chatHistoryData = sampleChats;
      renderChatHistory();
    }

    // Reset input after form submission
    searchForm.addEventListener('submit', () => {
      setTimeout(() => {
        searchInput.value = '';
        searchInput.style.height = 'auto';
      }, 100);
    });

    // Placeholder animation
    const placeholders = [
      "Ask me anything",
      "Ask me about Business",
      "Ask me about Comparative study"
    ];

    let phIndex = 0;
    let charIndex = 0;
    let currentText = "";
    let isDeleting = false;
    let cursorVisible = true;
    let typingActive = true;

    function typePlaceholder() {
      if (!searchInput || !typingActive) return;

      if (isDeleting) {
        currentText = placeholders[phIndex].substring(0, charIndex--);
      } else {
        currentText = placeholders[phIndex].substring(0, charIndex++);
      }

      const cursor = cursorVisible ? "|" : " ";
      searchInput.setAttribute("placeholder", currentText + cursor);

      if (!isDeleting && charIndex === placeholders[phIndex].length) {
        isDeleting = true;
        setTimeout(typePlaceholder, 1000);
        return;
      } else if (isDeleting && charIndex === 0) {
        isDeleting = false;
        phIndex = (phIndex + 1) % placeholders.length;
      }

      setTimeout(typePlaceholder, isDeleting ? 60 : 120);
    }

    setInterval(() => {
      cursorVisible = !cursorVisible;
    }, 500);

    setTimeout(typePlaceholder, 500);

    searchInput.addEventListener("input", () => {
      typingActive = false;
      searchInput.setAttribute("placeholder", "");
    });
  </script>
</body>
</html>